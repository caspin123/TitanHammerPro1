package com.titanhammer.listeners;

import com.titanhammer.TitanHammerPro;
import org.bukkit.GameMode;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.enchantment.EnchantItemEvent;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.event.inventory.InventoryDragEvent;
import org.bukkit.event.inventory.InventoryType;
import org.bukkit.event.player.PlayerDropItemEvent;
import org.bukkit.event.player.PlayerSwapHandItemsEvent;
import org.bukkit.inventory.AnvilInventory;
import org.bukkit.inventory.GrindstoneInventory;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.SmithingInventory;

public class AntiExploitListener implements Listener {

    private final TitanHammerPro plugin;

    public AntiExploitListener(TitanHammerPro plugin) {
        this.plugin = plugin;
    }

    /**
     * Prevent Silk Touch from being applied to TitanHammer
     */
    @EventHandler(priority = EventPriority.HIGH)
    public void onEnchant(EnchantItemEvent event) {
        if (!plugin.getConfigManager().isAntiSilkTouch()) return;

        if (plugin.getItemManager().isTitanHammer(event.getItem())) {
            // Remove silk touch if present in enchants
            if (event.getEnchantsToAdd().containsKey(Enchantment.SILK_TOUCH)) {
                event.getEnchantsToAdd().remove(Enchantment.SILK_TOUCH);
            }
        }
    }

    /**
     * Prevent TitanHammer from being placed in anvils/grindstones/smithing tables
     * to prevent duplication and enchantment exploits
     */
    @EventHandler(priority = EventPriority.HIGH)
    public void onInventoryClick(InventoryClickEvent event) {
        if (!plugin.getConfigManager().isAntiDupe()) return;
        if (!(event.getWhoClicked() instanceof Player player)) return;

        // Block TitanHammer in crafting inventories
        if (event.getInventory() instanceof AnvilInventory ||
                event.getInventory() instanceof GrindstoneInventory ||
                event.getInventory() instanceof SmithingInventory ||
                event.getInventory().getType() == InventoryType.WORKBENCH) {

            ItemStack cursor = event.getCursor();
            ItemStack current = event.getCurrentItem();

            if (plugin.getItemManager().isTitanHammer(cursor) || plugin.getItemManager().isTitanHammer(current)) {
                // Only cancel if trying to place in the crafting inventory, not player inventory
                if (event.getRawSlot() < event.getInventory().getSize()) {
                    event.setCancelled(true);
                    plugin.getMessageManager().send(player, "anti-exploit-blocked");
                }
            }
        }

        // Prevent non-owners from picking up the hammer
        if (event.getCurrentItem() != null && plugin.getItemManager().isTitanHammer(event.getCurrentItem())) {
            if (!plugin.getItemManager().isOwner(event.getCurrentItem(), player)) {
                if (!player.hasPermission("titanhammer.admin")) {
                    event.setCancelled(true);
                    plugin.getMessageManager().send(player, "not-your-hammer");
                }
            }
        }

        // Block creative mode duplication
        if (plugin.getConfigManager().isAntiCreative() && player.getGameMode() == GameMode.CREATIVE) {
            if (plugin.getItemManager().isTitanHammer(event.getCurrentItem())) {
                if (event.getClick().isShiftClick() || event.getClick().isCreativeAction()) {
                    event.setCancelled(true);
                }
            }
        }
    }

    /**
     * Prevent drag-duplication
     */
    @EventHandler(priority = EventPriority.HIGH)
    public void onInventoryDrag(InventoryDragEvent event) {
        if (!plugin.getConfigManager().isAntiDupe()) return;

        if (plugin.getItemManager().isTitanHammer(event.getOldCursor())) {
            if (event.getInventory() instanceof AnvilInventory ||
                    event.getInventory() instanceof GrindstoneInventory ||
                    event.getInventory() instanceof SmithingInventory) {

                for (int slot : event.getRawSlots()) {
                    if (slot < event.getInventory().getSize()) {
                        event.setCancelled(true);
                        return;
                    }
                }
            }
        }
    }

    /**
     * Prevent dropping TitanHammer (optional security)
     */
    @EventHandler
    public void onDrop(PlayerDropItemEvent event) {
        if (plugin.getItemManager().isTitanHammer(event.getItemDrop().getItemStack())) {
            // Allow dropping but mark for anti-pickup
            // This is optional - can be configured
        }
    }

    /**
     * Handle off-hand swap for silk touch exploit prevention
     */
    @EventHandler
    public void onSwapHand(PlayerSwapHandItemsEvent event) {
        // Allow swapping but ensure hammer stays functional
        ItemStack mainHand = event.getMainHandItem();
        ItemStack offHand = event.getOffHandItem();

        if (plugin.getItemManager().isTitanHammer(mainHand) || plugin.getItemManager().isTitanHammer(offHand)) {
            // Check for silk touch books in the other hand
            if (plugin.getConfigManager().isAntiSilkTouch()) {
                ItemStack other = plugin.getItemManager().isTitanHammer(mainHand) ? offHand : mainHand;
                if (other != null && other.containsEnchantment(Enchantment.SILK_TOUCH)) {
                    event.setCancelled(true);
                    plugin.getMessageManager().send(event.getPlayer(), "anti-exploit-blocked");
                }
            }
        }
    }
}
